<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3x3 マルバツゲーム</title>
    <style>
        body {
            display: flex;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
        }
        #console {
            width: 200px;
            background-color: #000;
            color: #0f0;
            padding: 10px;
            font-family: Consolas, monospace;
            overflow-y: auto;
            height: 100%;
            white-space: pre-wrap;
        }
        #game-area {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }
        #game-board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 5px;
            margin-bottom: 20px;
        }
        .cell {
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            background-color: #fff;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .cell.disabled {
            cursor: not-allowed;
        }
        #reset-btn {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        #popup {
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            text-align: center;
            display: none;
            z-index: 100;
            width: 300px;
            position: relative;
        }
        #popup-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }
        #popup-buttons button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 50;
        }
    </style>
</head>
<body>
    <div id="console"></div>
    <div id="game-area">
        <div id="game-board">
            <div class="cell" data-index="0"></div>
            <div class="cell" data-index="1"></div>
            <div class="cell" data-index="2"></div>
            <div class="cell" data-index="3"></div>
            <div class="cell" data-index="4"></div>
            <div class="cell" data-index="5"></div>
            <div class="cell" data-index="6"></div>
            <div class="cell" data-index="7"></div>
            <div class="cell" data-index="8"></div>
        </div>
        <button id="reset-btn">リセット</button>

        <div id="popup">
            <p id="popup-message"></p>
            <div id="popup-buttons">
                <button id="restart-btn">リスタート</button>
                <button id="replay-btn">リプレイ</button>
            </div>
        </div>

        <div id="overlay"></div>
    </div>

    <script>
        const cells = document.querySelectorAll('.cell');
        const resetBtn = document.getElementById('reset-btn');
        const popup = document.getElementById('popup');
        const overlay = document.getElementById('overlay');
        const popupMessage = document.getElementById('popup-message');
        const restartBtn = document.getElementById('restart-btn');
        const replayBtn = document.getElementById('replay-btn');
        const consoleElement = document.getElementById('console');

        let playerHistory = [];
        let computerHistory = [];
        let isReplaying = false;

        const winningCombinations = [
            [0, 1, 2],
            [3, 4, 5],
            [6, 7, 8],
            [0, 3, 6],
            [1, 4, 7],
            [2, 5, 8],
            [0, 4, 8],
            [2, 4, 6]
        ];

        function logBoardState(prefix) {
            let boardState = '';
            cells.forEach((cell) => {
                boardState += cell.textContent === '○' ? 'o' : cell.textContent === '×' ? 'x' : '-';
            });
            consoleElement.textContent += `${prefix} ${boardState}\n`; // プレフィックス付きで出力
            consoleElement.scrollTop = consoleElement.scrollHeight; // 最新のログを表示
        }

        function checkWinner(marker) {
            for (let combination of winningCombinations) {
                if (combination.every(index => cells[index].textContent === marker)) {
                    highlightWinningCombination(combination);
                    return true;
                }
            }
            return false;
        }

        function highlightWinningCombination(combination) {
            combination.forEach(index => {
                cells[index].style.backgroundColor = 'red';
            });
        }

        function findWinningMove(marker) {
            for (let combo of winningCombinations) {
                const [a, b, c] = combo;
                const values = [cells[a].textContent, cells[b].textContent, cells[c].textContent];
                if (values.filter(v => v === marker).length === 2 && values.includes('')) {
                    return [a, b, c].find(index => cells[index].textContent === '');
                }
            }
            return null;
        }

        function findStrategicMove(marker) {
            for (let combo of winningCombinations) {
                const [a, b, c] = combo;
                const values = [cells[a].textContent, cells[b].textContent, cells[c].textContent];
                if (values.filter(v => v === marker).length === 2 && values.filter(v => v === '-').length === 1) {
                    const emptyIndex = [a, b, c].find(index => cells[index].textContent === '-');
                    if (playerHistory.includes(emptyIndex)) {
                        return emptyIndex;
                    }
                }
            }
            return null;
        }

        function computerMove() {
            // 1. 勝利可能性の確認
            let winningMove = findWinningMove('×');
            if (winningMove !== null) {
                placeMarker(cells[winningMove], '×');
                return;
            }

            // 2. 必勝法の実行
            let strategicMove = findStrategicMove('×');
            if (strategicMove !== null) {
                placeMarker(cells[strategicMove], '×');
                return;
            }

            // 3. 相手の勝利阻止
            let blockingMove = findWinningMove('○');
            if (blockingMove !== null) {
                placeMarker(cells[blockingMove], '×');
                return;
            }

            // 4. 中心の配置
            if (cells[4].textContent === '') {
                placeMarker(cells[4], '×');
                return;
            }

            // 5. ランダムな場所への配置
            const emptyCells = Array.from(cells).filter(cell => cell.textContent === '');
            if (emptyCells.length === 0) return;

            const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
            placeMarker(randomCell, '×');
        }

        function placeMarker(cell, marker) {
            if (marker === '○' && !isReplaying) {
                if (playerHistory.length >= 3) {
                    const oldIndex = playerHistory.shift();
                    cells[oldIndex].textContent = '';
                    cells[oldIndex].classList.remove('disabled');
                }
                playerHistory.push(cell.getAttribute('data-index'));
                cell.textContent = marker;
                cell.classList.add('disabled');
                logBoardState('you:');
            } else if (marker === '×' && !isReplaying) {
                if (computerHistory.length >= 3) {
                    const oldIndex = computerHistory.shift();
                    cells[oldIndex].textContent = '';
                    cells[oldIndex].classList.remove('disabled');
                }
                computerHistory.push(cell.getAttribute('data-index'));
                cell.textContent = marker;
                cell.classList.add('disabled');
                logBoardState('cpu:');
            }

            if (checkWinner(marker)) {
                showPopup(marker === '○' ? 'あなたの勝ち！' : 'コンピューターの勝ち！');
            }
        }

        function resetGame() {
            cells.forEach(cell => {
                cell.textContent = '';
                cell.style.backgroundColor = ''; // 背景色をリセット
                cell.classList.remove('disabled');
            });
            playerHistory = [];
            computerHistory = [];
            isReplaying = false;
            closePopup();
        }

        function showPopup(message) {
            popupMessage.textContent = message;
            popup.style.display = 'block';
            overlay.style.display = 'block';
        }

        function closePopup() {
            popup.style.display = 'none';
            overlay.style.display = 'none';
        }

        function replayGame() {
            resetGame(); // 盤面をクリア
            isReplaying = true;

            const logLines = consoleElement.textContent.trim().split('\n').filter(line => line.startsWith('you:') || line.startsWith('cpu:'));
            let index = 0;

            function nextMove() {
                if (index < logLines.length) {
                    const logLine = logLines[index];
                    const boardState = logLine.split(' ')[1];

                    cells.forEach((cell, i) => {
                        if (boardState[i] === 'o') {
                            cell.textContent = '○';
                            cell.classList.add('disabled');
                        } else if (boardState[i] === 'x') {
                            cell.textContent = '×';
                            cell.classList.add('disabled');
                        } else {
                            cell.textContent = '';
                            cell.classList.remove('disabled');
                        }
                    });

                    index++;
                    setTimeout(nextMove, 1000); // 1秒ごとに次の手を表示
                } else {
                    // 3つ揃っているか確認し、揃っていればハイライトする
                    ['○', '×'].forEach(marker => {
                        if (checkWinner(marker)) {
                            setTimeout(() => {
                                showPopup(marker === '○' ? 'あなたの勝ち！' : 'コンピューターの勝ち！');
                            }, 1000); // 1秒後にポップアップを表示
                        }
                    });
                }
            }

            nextMove(); // リプレイを開始
        }

        cells.forEach(cell => {
            cell.addEventListener('click', () => {
                if (cell.textContent === '' && !isReplaying && overlay.style.display !== 'block') {
                    placeMarker(cell, '○');
                    if (!checkWinner('○')) {
                        computerMove();
                    }
                }
            });
        });

        resetBtn.addEventListener('click', resetGame);
        restartBtn.addEventListener('click', resetGame);
        replayBtn.addEventListener('click', replayGame);

        // ゲーム開始時に「Game Start」をコンソールに出力
        consoleElement.textContent = 'Game Start\n';
    </script>
</body>
</html>
